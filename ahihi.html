<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>B·∫£n ƒë·ªì m∆∞a tr·ª±c ti·∫øp</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap">
  <style>
    :root {
      --primary-color: #007BFF; --primary-hover: #0056b3; --error-color: #d32f2f;
      --success-color: #28a745; --info-color: #17a2b8; --background-light: #f4f4f4;
      --text-color: #333; --panel-bg: #ffffff;
    }
    body {
      margin: 0; padding: 0; font-family: 'Roboto', sans-serif;
      overflow: hidden;
    }
    #map-container {
      width: 100vw;
      height: 100vh;
      position: relative;
    }
    #map { height: 100%; width: 100%; }

    #control-panel {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      padding: 10px 15px 15px 15px;
      background: linear-gradient(to top, rgba(0,0,0,0.65), transparent);
      color: white;
    }
    #time-slider-label, #opacity-label {
      color: white;
      text-shadow: 0 1px 4px rgba(0,0,0,0.8);
    }
    #time-slider.ui-widget-content {
        background: rgba(255, 255, 255, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.4);
    }
    #time-slider .ui-slider-handle {
        background: #ffffff;
        border: 1px solid #999;
    }

    #top-controls { display: flex; align-items: center; justify-content: center; padding: 0 10px; margin-bottom: 5px; }
    #time-slider-label { text-align: center; font-size: 1rem; min-height: 20px; flex-grow: 1; margin: 0; color: #E0E0E0; }
    #opacity-controls { display: none; }
    #time-slider-container { flex-grow: 1; margin: 0 10px; }
    #loading-spinner { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; z-index: 3000; }
    @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
    
    .info-box {
      background: rgba(255, 255, 255, 0.95); border: 1px solid #ccc;
      padding: 8px; margin: 10px; border-radius: 4px;
      max-width: 300px; position: absolute; top: 60px; left: 10px; z-index: 800;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto;
      font-size: 14px;
    }
    .info-box h3 { margin: 0 0 8px 0; font-size: 1.1em; }
    .info-box h4 { margin: 8px 0 4px 0; font-size: 1.05em; border-top: 1px solid #ddd; padding-top: 8px; }
    .info-box p { margin: 5px 0; }
    .info-box .current-weather-main { display: flex; align-items: center; font-weight: bold; }
    .info-box .current-weather-main img { width: 40px; height: 40px; margin-right: 5px; }
    .info-box .forecast-item { display: flex; justify-content: space-between; font-size: 0.95em; padding: 3px 0; }
    .info-box.hidden { display: none; }
    .weather-header { position: relative; }
    .weather-close-btn { position: absolute; top: -5px; right: -5px; background: #fff; border: 1px solid #ccc; border-radius: 50%; width: 24px; height: 24px; line-height: 22px; text-align: center; font-size: 18px; font-weight: bold; cursor: pointer; color: #888; }
    .set-home-btn { margin-top: 8px; padding: 4px 10px; font-size: 12px; background-color: var(--primary-color); color: white; border: none; border-radius: 3px; cursor: pointer; width: 100%; }
    
    #toast-notification { position: fixed; bottom: 80px; right: 20px; z-index: 3500; padding: 12px 20px; border-radius: 6px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 15px; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s, transform 0.3s; transform: translateY(20px); }
    #toast-notification.show { opacity: 1; visibility: visible; transform: translateY(0); }
    #toast-notification.success { background-color: var(--success-color); }
    #toast-notification.error { background-color: var(--error-color); }
    #toast-notification.info { background-color: var(--info-color); }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2900; display: none; justify-content: center; align-items: center; }
    .modal-overlay.visible { display: flex; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; max-width: 500px; width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
    .modal-close-btn { position: absolute; top: 10px; right: 10px; font-size: 24px; background: none; border: none; cursor: pointer; color: #888; }
    .modal-footer { margin-top: 20px; display: flex; justify-content: flex-end; }
    .leaflet-routing-container { display: none !important; }

    #search-ui-container {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: var(--panel-bg);
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      display: flex;
      gap: 5px;
    }
    #search-ui-container input { padding: 5px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; width: 250px; }
    #search-ui-container button { padding: 5px 10px; font-size: 14px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
    
    #play-pause-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 10px;
      gap: 20px;
    }
    #play-pause-wrapper button {
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(0,0,0,0.2);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      line-height: 1;
      color: #333;
      transition: background-color 0.2s, color 0.2s;
    }
    #play-pause-wrapper button:hover {
      background: white;
    }

    .btn-active {
        background: var(--primary-color) !important;
        color: white !important;
        border-color: var(--primary-hover) !important;
    }

    #right-controls-container {
      position: absolute;
      top: 33%;
      right: 10px;
      transform: translateY(-50%);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #right-controls-container a {
      width: 44px;
      height: 44px;
      background-color: white;
      border-radius: 50%;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: flex;
      justify-content: center;
      align-items: center;
      text-decoration: none;
      color: #333;
    }
    #right-controls-container a svg {
      width: 24px;
      height: 24px;
      fill: currentColor;
    }
    
    .legend-panel {
      position: absolute;
      bottom: 125px; 
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      line-height: 1.2;
    }
    .legend-panel.hidden {
        display: none;
    }
    .legend-title { font-weight: 700; margin-bottom: 5px; font-size: 14px; }
    .legend-item { display: flex; align-items: center; font-size: 12px; }
    .legend-color { width: 20px; height: 10px; margin-right: 5px; border: 1px solid #ddd;}
  </style>
</head>
<body>
  <div id="map-container">
    <div id="map"></div>
    <div id="loading-spinner"></div>
    <div class="info-box hidden" id="weather-info"></div>
    
    <div id="search-ui-container">
      <input type="text" id="search-input" aria-label="Search address">
      <button id="search-button">OK</button>
    </div>

    <div id="right-controls-container">
        <a href="#" id="locate-btn" title="Hi·ªÉn th·ªã v·ªã tr√≠ c·ªßa t√¥i">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
        </a>
        <a href="#" id="directions-btn" title="T√¨m ƒë∆∞·ªùng">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m22.43 10.59-9.02-9.02c-.38-.38-1-.38-1.39 0L3 10.59c-.63.63-.19 1.71.7 1.71H8v5c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-5h4.29c.9 0 1.34-1.08.71-1.71z"/></svg>
        </a>
        <a href="#" id="upload-kmz-btn" title="T·∫£i l√™n t·ªáp KMZ">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
        </a>
        <input type="file" id="kmz-upload-input" accept=".kmz,.kml" multiple style="display: none;">
    </div>

    <div class="legend-panel hidden" id="legend-panel-wrapper"></div>
    
    <div id="control-panel">
      <div id="top-controls">
          <div id="opacity-controls">
              <label for="opacity-slider" id="opacity-label"></label>
              <input type="range" id="opacity-slider" min="0" max="1" step="0.1" value="0.8">
          </div>
          <div id="time-slider-label"></div>
      </div>
      <div id="time-slider-container">
          <div id="time-slider"></div>
      </div>
      <div id="play-pause-wrapper">
          <button id="info-btn" title="·∫®n/Hi·ªán th√¥ng tin th·ªùi ti·∫øt">‚ÑπÔ∏è</button>
          <button id="play-pause-btn">‚ñ∂Ô∏è</button>
          <button id="legend-btn" title="·∫®n/Hi·ªán ch√∫ gi·∫£i">üìú</button>
      </div>
    </div>
  </div>

  <div id="toast-notification"></div>

  <div id="directions-modal" class="modal-overlay">
      <div class="modal-content">
          <button class="modal-close-btn" onclick="toggleDirectionsModal(false)">&times;</button>
          <h2 data-i18n-text="directionsTitle"></h2>
          <div style="display: flex; flex-direction: column; gap: 15px;">
              <div>
                  <label for="directions-start-input" data-i18n-text="startPlaceholder"></label>
                  <input type="text" id="directions-start-input" style="width: 100%; padding: 8px; box-sizing: border-box;">
                  <button id="use-location-btn" data-i18n-text="useMyLocationBtn" style="width: 100%; padding: 8px; margin-top: 5px;"></button>
              </div>
              <div>
                  <label for="directions-end-input" data-i18n-text="endPlaceholder"></label>
                  <input type="text" id="directions-end-input" style="width: 100%; padding: 8px; box-sizing: border-box;">
              </div>
              <div id="directions-summary" style="text-align: center; font-weight: bold;"></div>
          </div>
          <div class="modal-footer">
              <button id="get-directions-btn" data-i18n-text="getDirectionsBtn"></button>
          </div>
      </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>

  <script>
    const appState = {
      map: null, rainLayer: null, userMarker: null, homeMarker: null, searchMarker: null,
      routingControl: null, timelines: [], currentUserPosition: null, homePosition: null,
      lastRainData: null, lastWeatherData: null, animationInterval: null,
      // B·ªî SUNG: Tr·∫°ng th√°i cho KMZ
      kmzLayers: [], 
      currentLanguage: 'vi',
      openWeatherApiKey: '07634769a5de7a23837694d8813c38d4',
      googleApiKey: 'AIzaSyAuRWIozMKFbaB82wW1NqRvBGcF8_q_fSg'
    };

    const translations = {
      pageTitle: { en: 'Live Rain Map', vi: 'B·∫£n ƒë·ªì m∆∞a tr·ª±c ti·∫øp' },
      locateTitle: { en: 'Show my location', vi: 'Hi·ªÉn th·ªã v·ªã tr√≠ c·ªßa t√¥i' },
      directionsTitle: { en: 'Get Directions', vi: 'T√¨m ƒë∆∞·ªùng' },
      // B·ªî SUNG: Ti√™u ƒë·ªÅ cho n√∫t t·∫£i KMZ
      uploadTitle: { en: 'Upload KMZ File', vi: 'T·∫£i l√™n t·ªáp KMZ' },
      searchPlaceholder: { en: 'Enter an address', vi: 'Nh·∫≠p m·ªôt ƒë·ªãa ch·ªâ' },
      couldNotFindAddress: { en: 'Could not find address', vi: 'Kh√¥ng th·ªÉ t√¨m th·∫•y ƒë·ªãa ch·ªâ' },
      searchError: { en: 'Search error', vi: 'L·ªói t√¨m ki·∫øm' },
      legendToggleTitle: { en: 'Show/hide legend', vi: '·∫®n/hi·ªán ch√∫ gi·∫£i' },
      infoToggleTitle: { en: 'Show/hide weather info', vi: '·∫®n/hi·ªán th√¥ng tin th·ªùi ti·∫øt' },
      startPlaceholder: { en: 'Starting point', vi: 'ƒêi·ªÉm b·∫Øt ƒë·∫ßu' },
      endPlaceholder: { en: 'Destination', vi: 'ƒêi·ªÉm ƒë·∫øn' },
      useMyLocationBtn: { en: 'Use my current location', vi: 'S·ª≠ d·ª•ng v·ªã tr√≠ c·ªßa t√¥i' },
      getDirectionsBtn: { en: 'Show Route on Map', vi: 'Hi·ªÉn th·ªã Tuy·∫øn ƒë∆∞·ªùng' },
      routeSummary: { en: 'Distance: {distance}, Time: {time}', vi: 'Kho·∫£ng c√°ch: {distance}, Th·ªùi gian: {time}'},
      errorRoute: { en: 'Could not calculate the route.', vi: 'Kh√¥ng th·ªÉ t√≠nh to√°n tuy·∫øn ƒë∆∞·ªùng.'},
      opacityLabel: { en: 'Opacity:', vi: 'ƒê·ªô m·ªù:' },
      legendTitle: { en: 'Rainfall Intensity', vi: 'C∆∞·ªùng ƒë·ªô m∆∞a' },
      lightRain: { en: 'Light rain', vi: 'M∆∞a nh·ªè' },
      moderateRain: { en: 'Moderate rain', vi: 'M∆∞a v·ª´a' },
      heavyRain: { en: 'Heavy rain', vi: 'M∆∞a to' },
      veryHeavyRain: { en: 'Very heavy rain', vi: 'M∆∞a r·∫•t to' },
      noRain: { en: 'No rain', vi: 'Kh√¥ng c√≥ m∆∞a' },
      loadingWeather: { en: 'Loading weather...', vi: 'ƒêang t·∫£i th·ªùi ti·∫øt...' },
      dataFor: { en: 'Rainfall data at:', vi: 'D·ªØ li·ªáu m∆∞a l√∫c:' },
      errorLoadingData: { en: 'Error loading data', vi: 'L·ªói t·∫£i d·ªØ li·ªáu' },
      weatherFor: { en: 'Weather for', vi: 'Th·ªùi ti·∫øt cho' },
      now: { en: 'Now', vi: 'B√¢y gi·ªù' },
      humidity: { en: 'Humidity', vi: 'ƒê·ªô ·∫©m' },
      wind: { en: 'Wind', vi: 'Gi√≥' },
      next24Hours: { en: 'Next 24 Hours Forecast', vi: 'D·ª± b√°o 24 gi·ªù t·ªõi' },
      yourLocation: { en: 'Your Location', vi: 'V·ªã tr√≠ c·ªßa b·∫°n' },
      setAsHome: { en: 'Set as Home', vi: 'ƒê·∫∑t l√†m nh√†' },
      homeLocationSaved: { en: 'Home location saved!', vi: 'ƒê√£ l∆∞u v·ªã tr√≠ nh√†!' },
      yourHomeLocation: { en: 'Your Home Location', vi: 'V·ªã tr√≠ Nh√† c·ªßa b·∫°n' },
      linkCopied: { en: 'Shareable link copied!', vi: 'ƒê√£ sao ch√©p li√™n k·∫øt!' },
      close: { en: 'Close', vi: 'ƒê√≥ng' },
      selectLocationForWeather: { en: 'Please click on the map to see weather info.', vi: 'Vui l√≤ng nh·∫•p v√†o b·∫£n ƒë·ªì ƒë·ªÉ xem th√¥ng tin th·ªùi ti·∫øt.'}
    };

    function debounce(func, wait) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; }
    function toggleLoading(isLoading) { document.getElementById('loading-spinner').style.display = isLoading ? 'block' : 'none'; }
    function showToast(messageKey, type = 'info', duration = 3000) {
        const message = translations[messageKey]?.[appState.currentLanguage] || messageKey;
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.className = 'show ' + type;
        setTimeout(() => { toast.className = toast.className.replace('show', ''); }, duration);
    }

    function updateUIForLanguage() {
        const lang = appState.currentLanguage;
        document.documentElement.lang = lang;
        document.title = translations.pageTitle[lang];
        document.querySelectorAll('[data-i18n-text]').forEach(el => { const key = el.getAttribute('data-i18n-text'); if (translations[key]?.[lang]) el.textContent = translations[key][lang]; });
        document.querySelectorAll('[title]').forEach(el => {
            const key = el.getAttribute('data-i18n-title-key');
            if (key && translations[key]?.[lang]) el.title = translations[key][lang];
        });
        document.getElementById('opacity-label').textContent = translations.opacityLabel[lang];
        document.getElementById('search-input').placeholder = translations.searchPlaceholder[lang];
        if (document.getElementById('directions-start-input').dataset.isMyLocation === 'true') { document.getElementById('directions-start-input').value = translations.yourLocation[lang]; }
        if (appState.lastWeatherData) { renderWeather(appState.lastWeatherData.weather, appState.lastWeatherData.name); }
        // B·ªï sung: C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ cho n√∫t KMZ
        document.getElementById('upload-kmz-btn').title = translations.uploadTitle[lang];
    }
    
    function hideWeatherInfoPanel() {
        document.getElementById('weather-info').classList.add('hidden');
        document.getElementById('info-btn').classList.remove('btn-active');
    }

    function toggleWeatherInfo() {
        if (appState.lastWeatherData) {
            document.getElementById('weather-info').classList.toggle('hidden');
            document.getElementById('info-btn').classList.toggle('btn-active');
        } else {
            showToast('selectLocationForWeather', 'info');
        }
    }

    function initializeMap() {
      appState.map = L.map('map', { zoomControl: false }).setView([10.779950608738902, 106.69984680231464], 9);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(appState.map);
      
      appState.map.on('click', (e) => {
          placeWeatherMarker(e.latlng, null)
      });
    }

    async function updateRainLayer(timestampIndex = -1) {
        toggleLoading(true);
        try {
            const response = await fetch('https://api.rainviewer.com/public/weather-maps.json');
            if (!response.ok) throw new Error('Network error');
            const data = await response.json();
            appState.lastRainData = data;
            const past = data.radar.past.filter(t => t && t.path);
            const nowcast = (data.radar.nowcast || []).filter(t => t && t.path);
            appState.timelines = [...past, ...nowcast];

            let selectedIndex = (timestampIndex !== -1) ? timestampIndex : past.length - 1;
            showRainLayer(selectedIndex);
            $("#time-slider").slider({
                min: 0, max: appState.timelines.length - 1, value: selectedIndex,
                slide: (e, ui) => { stopAnimation(); showRainLayer(ui.value); },
            });
        } catch (error) { showToast('errorLoadingData', 'error'); }
        finally { toggleLoading(false); }
    }

    function showRainLayer(index) {
        if (!appState.timelines?.[index]) return;
        const timeline = appState.timelines[index];
        const locale = appState.currentLanguage === 'vi' ? 'vi-VN' : 'en-US';
        const timeStr = new Date(timeline.time * 1000).toLocaleString(locale, { hour: '2-digit', minute: '2-digit' });
        document.getElementById('time-slider-label').innerHTML = `${translations.dataFor[appState.currentLanguage]} ${timeStr}`;

        const tileUrl = `${appState.lastRainData.host}${timeline.path}/256/{z}/{x}/{y}/7/1_0.png`;
        if (appState.rainLayer) appState.map.removeLayer(appState.rainLayer);
        appState.rainLayer = L.tileLayer(tileUrl, { opacity: 0.8 }).addTo(appState.map).bringToFront();
    }

    function placeWeatherMarker(latlng, name) {
      if (appState.searchMarker) appState.map.removeLayer(appState.searchMarker);
      const popupContent = document.createElement('div');
      const locationName = name ? name.split(',')[0] : `(${latlng.lat.toFixed(3)}, ${latlng.lng.toFixed(3)})`;
      popupContent.innerHTML = `<div>${locationName}</div><button class="set-home-btn" data-lat="${latlng.lat}" data-lng="${latlng.lng}">${translations.setAsHome[appState.currentLanguage]}</button>`;

      appState.searchMarker = L.marker(latlng).addTo(appState.map).bindPopup(popupContent).openPopup();
      popupContent.querySelector('.set-home-btn').addEventListener('click', (e) => {
          setHomeLocation(e.target.dataset.lat, e.target.dataset.lng);
      });
      getWeather(latlng.lat, latlng.lng, locationName);
    }
    
    async function getWeather(lat, lng, locationName) {
      const lang = appState.currentLanguage;
      document.getElementById('weather-info').innerHTML = `<div class="weather-header"><button class="weather-close-btn" aria-label="${translations.close[lang]}" onclick="hideWeatherInfoPanel()">&times;</button></div> ${translations.loadingWeather[lang]}`;
      document.getElementById('weather-info').classList.remove('hidden');
      document.getElementById('info-btn').classList.add('btn-active');
      
      try {
        const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lng}&appid=${appState.openWeatherApiKey}&units=metric&lang=${lang}`;
        const response = await fetch(url);
        if(!response.ok) throw new Error('Failed to fetch weather');
        const data = await response.json();
        if (!data.list?.length) throw new Error("No forecast data available.");
        appState.lastWeatherData = { weather: data, name: locationName };
        renderWeather(data, locationName);
      } catch (e) {
        console.error('Weather error:', e);
        document.getElementById('weather-info').innerHTML += `<br><span style="color:red;">Error loading weather.</span>`;
      }
    }
    
    function renderWeather(data, locationName) {
        const lang = appState.currentLanguage;
        const locale = lang === 'vi' ? 'vi-VN' : 'en-US';
        const current = data.list[0];
        const icon = `https://openweathermap.org/img/w/${current.weather[0].icon}.png`;
        
        let weatherHTML = `
          <div class="weather-header">
            <button class="weather-close-btn" aria-label="${translations.close[lang]}" onclick="hideWeatherInfoPanel()">&times;</button>
            <h3>${translations.weatherFor[lang]} ${locationName}</h3>
          </div>
          <div class="current-weather-main">
            <img src="${icon}" alt="${current.weather[0].description}">
            <span>${translations.now[lang]}: ${current.main.temp.toFixed(1)}¬∞C, ${current.weather[0].description}</span>
          </div>
          <p>${translations.humidity[lang]}: ${current.main.humidity}% | ${translations.wind[lang]}: ${current.wind.speed} m/s</p>
          <h4>${translations.next24Hours[lang]}</h4>`;

        for (let i = 1; i <= 8; i++) {
            if (!data.list[i]) break;
            const forecast = data.list[i];
            const time = new Date(forecast.dt * 1000).toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit'});
            weatherHTML += `<div class="forecast-item"><span>${time}:</span> <span>${forecast.main.temp.toFixed(1)}¬∞C, ${forecast.weather[0].description}</span></div>`;
        }
        
        document.getElementById('weather-info').innerHTML = weatherHTML;
    }

    function locateUser() {
        navigator.geolocation.getCurrentPosition(pos => {
            const { latitude: lat, longitude: lng } = pos.coords;
            appState.currentUserPosition = { lat, lng };
            appState.map.setView([lat, lng], 13);
            if (appState.userMarker) appState.map.removeLayer(appState.userMarker);
            appState.userMarker = L.marker([lat, lng]).addTo(appState.map)
              .bindPopup(translations.yourLocation[appState.currentLanguage]).openPopup();
            getWeather(lat, lng, translations.yourLocation[appState.currentLanguage]);
        }, () => showToast('Could not get your location.', 'error'));
    }

    function setHomeLocation(lat, lng) {
        appState.homePosition = { lat: parseFloat(lat), lng: parseFloat(lng) };
        localStorage.setItem('homePosition', JSON.stringify(appState.homePosition));
        if (appState.homeMarker) appState.map.removeLayer(appState.homeMarker);
        const homeIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/32/10396/10396921.png', iconSize: [32, 32]});
        appState.homeMarker = L.marker([lat, lng], { icon: homeIcon }).addTo(appState.map)
          .bindPopup(translations.yourHomeLocation[appState.currentLanguage]);
        showToast('homeLocationSaved', 'success');
        appState.map.closePopup();
    }

    function toggleDirectionsModal(show) { document.getElementById('directions-modal').classList.toggle('visible', show); }

    async function getDirections() {
        if (!appState.googleApiKey || appState.googleApiKey === 'YOUR_GOOGLE_API_KEY') {
            alert('Vui l√≤ng cung c·∫•p Google API Key ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.');
            return;
        }
        toggleLoading(true);
        if (appState.routingControl) { appState.map.removeControl(appState.routingControl); }

        const start = document.getElementById('directions-start-input').value;
        const end = document.getElementById('directions-end-input').value;

        const geocode = async (query) => {
            const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(query)}&key=${appState.googleApiKey}`;
            const resp = await fetch(url);
            const data = await resp.json();
            if (data.status !== 'OK') throw new Error('Geocoding failed');
            return L.latLng(data.results[0].geometry.location.lat, data.results[0].geometry.location.lng);
        };

        try {
            const startLatLng = document.getElementById('directions-start-input').dataset.isMyLocation === 'true' && appState.currentUserPosition
              ? L.latLng(appState.currentUserPosition.lat, appState.currentUserPosition.lng)
              : await geocode(start);
            const endLatLng = await geocode(end);

            appState.routingControl = L.Routing.control({
                waypoints: [startLatLng, endLatLng],
                show: false, addWaypoints: false,
                lineOptions: { styles: [{ color: '#007BFF', opacity: 0.9, weight: 7 }] },
                createMarker: function() { return null; }
            }).on('routesfound', function(e) {
                const summary = e.routes[0].summary;
                const distance = (summary.totalDistance / 1000).toFixed(2) + ' km';
                const time = Math.round(summary.totalTime / 60) + ' ph√∫t';
                document.getElementById('directions-summary').textContent = translations.routeSummary[appState.currentLanguage].replace('{distance}', distance).replace('{time}', time);
                toggleDirectionsModal(false);
            }).on('routingerror', () => showToast('errorRoute', 'error')).addTo(appState.map);

            appState.map.fitBounds(L.latLngBounds(startLatLng, endLatLng), {padding: [50, 50]});
        } catch(e) { showToast('errorRoute', 'error'); }
        finally { toggleLoading(false); }
    }
    
    async function searchAddress() {
        const query = document.getElementById('search-input').value.trim();
        if (!query) return;
        toggleLoading(true);
        const lang = appState.currentLanguage;
        try {
            const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(query)}&key=${appState.googleApiKey}&language=${lang}&region=${lang}`;
            const response = await fetch(url);
            const data = await response.json();
            if (data.status === 'OK' && data.results.length > 0) {
                const loc = data.results[0].geometry.location;
                const addr = data.results[0].formatted_address;
                appState.map.setView([loc.lat, loc.lng], 13);
                placeWeatherMarker(L.latLng(loc.lat, loc.lng), addr);
            } else { showToast(`${translations.couldNotFindAddress[lang]}: ${data.status}`, 'error'); }
        } catch (e) { showToast(`${translations.searchError[lang]}: ${e.message}`, 'error'); } finally { toggleLoading(false); }
    }
    
    function toggleLegend() {
        const legendWrapper = document.getElementById('legend-panel-wrapper');
        if (legendWrapper.innerHTML === '') {
            const lang = appState.currentLanguage;
            legendWrapper.innerHTML = `<div class="legend-title">${translations.legendTitle[lang]}</div>
                <div class="legend-item"><div class="legend-color" style="background: #e0e0e0;"></div>${translations.noRain[lang]}</div>
                <div class="legend-item"><div class="legend-color" style="background: #00FF00;"></div>${translations.lightRain[lang]}</div>
                <div class="legend-item"><div class="legend-color" style="background: #FFFF00;"></div>${translations.moderateRain[lang]}</div>
                <div class="legend-item"><div class="legend-color" style="background: #FF9900;"></div>${translations.heavyRain[lang]}</div>
                <div class="legend-item"><div class="legend-color" style="background: #FF0000;"></div>${translations.veryHeavyRain[lang]}</div>`;
        }
        legendWrapper.classList.toggle('hidden');
        document.getElementById('legend-btn').classList.toggle('btn-active');
    }
    
    // B·ªî SUNG: H√†m x·ª≠ l√Ω t·∫£i l√™n file KMZ
    function handleKMZUpload(event) {
        const files = event.target.files;
        if (!files.length) return;
        
        toggleLoading(true);
        
        // X√≥a c√°c l·ªõp KMZ c≈© tr∆∞·ªõc khi th√™m l·ªõp m·ªõi
        appState.kmzLayers.forEach(layer => {
            appState.map.removeLayer(layer);
        });
        appState.kmzLayers = [];

        const filePromises = Array.from(files).map(file => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const processFile = (kmlText) => {
                        const dom = (new DOMParser()).parseFromString(kmlText, 'text/xml');
                        const geojson = toGeoJSON.kml(dom);
                        resolve({ name: file.name, geojson: geojson });
                    };

                    if (file.name.toLowerCase().endsWith('.kmz')) {
                        JSZip.loadAsync(e.target.result).then(zip => {
                            const kmlFile = Object.keys(zip.files).find(name => name.toLowerCase().endsWith('.kml'));
                            if (!kmlFile) reject(new Error(`No .kml file found in ${file.name}`));
                            return zip.file(kmlFile).async('string');
                        }).then(processFile).catch(reject);
                    } else { // It's a KML file
                        processFile(e.target.result);
                    }
                };
                reader.onerror = reject;

                if (file.name.toLowerCase().endsWith('.kmz')) {
                    reader.readAsArrayBuffer(file);
                } else {
                    reader.readAsText(file);
                }
            });
        });

        Promise.all(filePromises).then(results => {
            const allBounds = [];
            results.forEach(result => {
                const layer = L.geoJSON(result.geojson, {
                    onEachFeature: function (feature, layer) {
                        let popupContent = '';
                        if (feature.properties.name) popupContent += `<b>${feature.properties.name}</b>`;
                        if (feature.properties.description) popupContent += `<br>${feature.properties.description}`;
                        if (popupContent) layer.bindPopup(popupContent);
                    }
                }).addTo(appState.map);
                appState.kmzLayers.push(layer); // Ch·ªâ l∆∞u layer, kh√¥ng c·∫ßn object ph·ª©c t·∫°p
                allBounds.push(layer.getBounds());
            });

            if (allBounds.length > 0) {
                const combinedBounds = allBounds.reduce((b, bds) => b.extend(bds), allBounds[0]);
                appState.map.fitBounds(combinedBounds);
            }
            toggleLoading(false);
        }).catch(err => {
            alert("Error processing file: " + err.message);
            toggleLoading(false);
        });
    }

    function stopAnimation() {
        clearInterval(appState.animationInterval);
        appState.animationInterval = null;
        document.getElementById('play-pause-btn').innerHTML = '‚ñ∂Ô∏è';
    }

    document.addEventListener('DOMContentLoaded', () => {
        initializeMap();
        updateUIForLanguage();
        updateRainLayer();

        const homePos = JSON.parse(localStorage.getItem('homePosition'));
        if(homePos) setHomeLocation(homePos.lat, homePos.lng);
        
        document.getElementById('info-btn').addEventListener('click', toggleWeatherInfo);
        document.getElementById('info-btn').setAttribute('data-i18n-title-key', 'infoToggleTitle');
        
        document.getElementById('legend-btn').addEventListener('click', toggleLegend);
        document.getElementById('legend-btn').setAttribute('data-i18n-title-key', 'legendToggleTitle');
        
        const locateBtn = document.getElementById('locate-btn');
        locateBtn.addEventListener('click', (e) => { e.preventDefault(); debounce(locateUser, 300)(); });
        locateBtn.setAttribute('data-i18n-title-key', 'locateTitle');

        const directionsBtn = document.getElementById('directions-btn');
        directionsBtn.addEventListener('click', (e) => { e.preventDefault(); toggleDirectionsModal(true); });
        directionsBtn.setAttribute('data-i18n-title-key', 'directionsTitle');

        // B·ªî SUNG: S·ª± ki·ªán cho n√∫t t·∫£i KMZ
        document.getElementById('upload-kmz-btn').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('kmz-upload-input').click();
        });
        document.getElementById('kmz-upload-input').addEventListener('change', handleKMZUpload);

        document.getElementById('play-pause-btn').addEventListener('click', () => {
            if (appState.animationInterval) { stopAnimation(); }
            else {
                document.getElementById('play-pause-btn').innerHTML = '‚è∏Ô∏è';
                appState.animationInterval = setInterval(() => {
                    const slider = $("#time-slider");
                    let nextVal = slider.slider("value") + 1;
                    if (nextVal >= appState.timelines.length) nextVal = 0;
                    slider.slider("value", nextVal);
                    showRainLayer(nextVal);
                }, 500);
            }
        });
        
        document.getElementById('use-location-btn').addEventListener('click', () => {
            if (!appState.currentUserPosition) locateUser();
            document.getElementById('directions-start-input').value = translations.yourLocation[appState.currentLanguage];
            document.getElementById('directions-start-input').dataset.isMyLocation = 'true';
        });

        document.getElementById('get-directions-btn').addEventListener('click', getDirections);
        
        document.getElementById('search-button').addEventListener('click', debounce(searchAddress, 300));
        document.getElementById('search-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') debounce(searchAddress, 300)(); });

        setInterval(() => {
            if (!document.hidden && !appState.animationInterval) updateRainLayer($("#time-slider").slider("value"));
        }, 600000);

        updateUIForLanguage();
    });
  </script>
</body>
</html>